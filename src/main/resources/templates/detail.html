<html layout:decorate="~{layout}">
<div layout:fragment="content">
    <link rel="stylesheet" th:href="@{/css/detail.css}" />
	<script src="/js/addcart.js"></script>
    <main class="detail-page-container">

        <!-- 상품 상세 -->
        <div class="product-wrap" th:if="${product != null}">
            <!-- 상품 이미지 -->
            <div class="product-image-section">
                <img th:src="|/${product.productImg}|"
                     th:alt="${product.productName}"
                     class="main-product-image">
            </div>

            <!-- 상품 정보 -->
            <div class="product-info-section">
                <h1 class="product-title" th:text="${product.productName}">상품 이름</h1>
                <p class="product-price" th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')} + '원'"></p>

                <div class="total-price-box">
                    <p>상품 금액</p>
                    <p class="total-price" th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')} + '원'"></p>
                </div>

                <div class="button-group">
                    <button class="add-to-cart-btn">장바구니추가</button>
					<button class="kakaopay-btn" th:onclick="'location.href=\'/payment/onebuy/' + ${product.productIdx} + '\';'">
					</button>
                </div>

                <div class="shipping-info">
                    <p>배송 방법: 택배</p>
                </div>
            </div>
        </div>

        <!-- product가 없을 때 메시지 -->
        <div th:if="${product == null}">
            <p>상품 정보를 찾을 수 없습니다.</p>
        </div>

        <!-- 상품 리뷰 -->
        <section class="reply-section">
            <div class="container">
                <h2>상품 리뷰</h2>

                <!-- 리뷰 작성 폼 (추후 POST 매핑 연결) -->
				<div class="reply-form">
				    <h3>리뷰 작성하기</h3>
				    <form id="replyForm">
				        <input type="hidden" id="productIdx" name="productIdx" th:value="${product.productIdx}">
				        <div class="form-group">
				            <label for="reply_content">내용</label>
				            <textarea id="reply_content" name="content"></textarea>
				        </div>
				        <button type="submit" class="submit-reply-btn">작성하기</button>
				    </form>
				</div>

				<!-- 리뷰 리스트 -->
				<div class="reply-list" id="replyList">
				    <h3>최근 리뷰</h3>

				    <!-- 리뷰 없을 때만 표시 -->
				    <div id="emptyMessage" th:if="${replies == null or #lists.isEmpty(replies)}">
				        <p>아직 작성된 리뷰가 없습니다.</p>
				    </div>

				    <!-- 리뷰가 있을 때만 반복 -->
				    <div th:unless="${replies == null or #lists.isEmpty(replies)}"
				         th:each="reply : ${replies}"
				         class="reply-item">
				        <div class="reply-meta">
				            <span class="reply-writer" th:text="${reply.writer}"></span>
				            <span class="reply-date" th:text="${reply.writeDate}"></span>
				        </div>
				        <div class="reply-content">
				            <p th:text="${reply.content}"></p>
				        </div>
				    </div>
				</div>

            </div>
        </section>

        <!-- 상품 상세 설명 -->
        <section class="product-detail-description" th:if="${product != null}">
            <p th:text="${product.productContent}">상품 상세 설명</p>
        </section>
    </main>
	<script th:inline="javascript">
		$(document).ready(function(){
			const isLogin = /*[[${isLogin}]]*/ false;
			const productIdx = /*[[${product.productIdx}]]*/ 0;
			
			$('#replyForm').on('submit', function(e){
				e.preventDefault();
				
				if(!isLogin){
					alert("로그인 후 댓글 작성이 가능합니다.");
					return false;
				}
		 
				const content = $('#reply_content').val().trim();
				if(!content){
					alert("댓글 내용이 없습니다.");
					return;
				}
				
				$.ajax({
					url:"/reply/add",
					type:"POST",
					data:{ productIdx:productIdx, content:content },
					success: function(reply) {
						appendReply(reply);
						$('#reply_content').val("");
						alert("댓글이 작성되었습니다.");
					},
					error: function(e) {
						console.error(e);
						alert("댓글 작성중 오류가 발생했습니다.");
					}
				});
			});
			function appendReply(reply) {
				$("#emptyMessage").remove();
				
				$("#replyList").append(`<div class="reply-item">
							               	<div class="reply-meta">
							                    <span class="reply-writer">${reply.writer}</span>
							                    <span class="reply-date">${reply.writeDate}</span>
							               </div>
							               <div class="reply-content">
							                   <p>${reply.content}</p>
							               </div>
							           </div>`);
			}
		});
	</script>
</div>
</html>